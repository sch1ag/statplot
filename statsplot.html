<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9">
    <title>Overall Performance</title>

    <script type="text/javascript" src="code/dygraph-combined.js"></script>
    <!--script type="text/javascript" src="code/dygraph-dev.js"></script-->

    <style type='text/css'>
      .few .dygraph-legend > span.highlight { background-color: yellow }
      .few div.dygraph-legend { background: none !important; font-weight: bold}
    </style>
  </head>
  <body>


<style>
  .thumb {
    height: 75px;
    border: 1px solid #000;
    margin: 10px 5px 0 0;
  }
</style>

<label for="files">Select csv files: </label><input type="file" id="files" name="files[]" multiple />
<label for="width">Plot width (blank=auto): </label><input type="text" name="width" id="width" pattern='[0-9]+'>

<script>
  clientwidth = document.documentElement.clientWidth
  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // Loop through the FileList
    for (var i = 0, f; f = files[i]; i++) {

      // Only process text files.
      if (! f.name.match(/\.csv$/)) {
	alert("File " + f.name + " is not a csv file!")
        continue;
      }

      var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = (function(theFile) {
          return function(e){
              makeMGraph("few", e.target.result, theFile.name);
          }
        })(f);

      reader.readAsText(f);
    }
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>


<script type='text/javascript'>

var makeMGraph = function(className, plotdata, title) {
  console.log(plotdata.slice(0, plotdata.indexOf("\n")));
  var div = document.createElement('div');
  div.className = className;
  div.style.display = 'inline-block';
  var btn=document.createElement("BUTTON");
  btn.appendChild(document.createTextNode("CLOSE"));
  btn.onclick = function(){this.parentNode.parentNode.removeChild(this.parentNode)}
  document.body.appendChild(div);
  
  plotwidth = document.getElementById('width').value != ''  ?  parseInt(document.getElementById('width').value) : 0.97 * clientwidth ;
  
  var general = {
        width: plotwidth,
        height: document.documentElement.clientWidth/3,
        title: title,
        delimiter: ',',
        xAxisLabelWidth: 70,
	yAxisLabelWidth: 80,
        xlabel: "Time",
        legend: 'always',
        labelsSeparateLines: true,

        rollPeriod: 1,
        showRoller: true,

        highlightCircleSize: 3,
        strokeWidth: 1,
        strokeBorderWidth: null, 
        highlightSeriesBackgroundAlpha: 1,

        highlightSeriesOpts: {
          strokeWidth: 2,
          //strokeBorderWidth: 1,
          highlightCircleSize: 4,
        },
        axes: {
               x: {
                    valueFormatter: function(ms) {
                      return new Date(ms).strftime('%Y-%m-%d %H:%M:%S');
                    },
                    pixelsPerLabel: 70,
                },
              }
        }

  var multiyIO = {
        'Read_IO': {
          axis: {},
          fillGraph: true,
          fillAlpha: 0.3
        },
        'Write_IO': {
          axis: 'Read_IO',
          fillGraph: true,
          fillAlpha: 0.3        
        }}

  var multiyKB = {
        'Read_KB':{axis: {},
                     fillGraph: true,
                     fillAlpha: 0.3
        }, 'Write_KB': {axis: 'Read_KB',
                     fillGraph: true,
                     fillAlpha: 0.3        
        }}

  var stacked = {
        axes: {
            x: {
                valueFormatter: function(ms) {
                    return new Date(ms).strftime('%Y-%m-%d %H:%M:%S');
                },
                pixelsPerLabel: 70,
            },
            y: {
                valueFormatter: function(val, opts, series_name, dygraph) {
                    return dygraph.getValue(dygraph.getSelection(),dygraph.indexFromSetName(series_name)) ;
                },
            },
        },
        stackedGraph: true
    }

  var l2ho = [
        {headers: ['Wait', 'System', 'User'], addopts: [stacked, {ylabel: 'CPU Load, %', valueRange: [null, 110]}]},
        {headers: ['RunQ', 'VmmQ', 'RawQ'], addopts: [{ylabel: 'CPU Queue, #'}]},
        {headers: ['Read_SRV', 'Write_SRV'], addopts: [{ylabel: 'Service Time, ms'}]},
        {headers: ['Read_IO', 'Write_IO'], addopts: [multiyIO, {y2label: 'IO per Sec, #'}]},
        {headers: ['Read_KB', 'Write_KB'], addopts: [multiyKB, {y2label: 'KiB per Sec, KiB'}]},
        {headers: ['Read_KB', 'Write_KB', 'Read_IO', 'Write_IO'], addopts: [{width: plotwidth+87}]}
    ]

  headers = plotdata.slice(0, plotdata.indexOf("\n")).split(',');
  for (h in headers) {
    for (l in l2ho) {
      if (l2ho[l].headers.indexOf(headers[h]) != -1) {
        for (o in l2ho[l].addopts) {
          for (attr in l2ho[l].addopts[o]) { general[attr] = l2ho[l].addopts[o][attr] } 
        }
      } 
    } 
  }
  
  var g = new Dygraph(
      div,
      plotdata,
      general
      );
  div.appendChild(btn);
};

</script>
</body>
</html>
